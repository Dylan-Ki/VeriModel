name: CI (Lint, Test & Security Scan)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual trigger

env:
  PYTHON_VERSION_MATRIX: "['3.10', '3.11', '3.12']"

jobs:
  # Lint job - cháº¡y song song vá»›i test Ä‘á»ƒ tiáº¿t kiá»‡m thá»i gian
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install linting dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black flake8

      - name: Check code formatting with Black
        run: |
          black --check --diff .

      - name: Run Flake8 linter
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true  # KhÃ´ng fail build náº¿u cÃ³ warnings

  # Test job vá»›i matrix strategy cho multiple Python versions
  test:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ['3.10', '3.11', '3.12']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install system dependencies (for yara-python)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libyara-dev

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run tests with pytest
        run: |
          pytest tests/ -v --cov=verimodel --cov-report=xml --cov-report=term-missing

      - name: Upload coverage to Codecov (optional)
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  # Security scan job
  security_scan:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit

      - name: Run pip-audit on requirements.txt
        run: |
          pip-audit -r requirements.txt --format=json --output=pip-audit-report.json
          pip-audit -r requirements.txt
        continue-on-error: true  # KhÃ´ng fail build nhÆ°ng váº«n bÃ¡o cÃ¡o vulnerabilities

      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pip-audit-report
          path: pip-audit-report.json
          retention-days: 30

  # Build check - kiá»ƒm tra code cÃ³ thá»ƒ build Ä‘Æ°á»£c khÃ´ng
  build_check:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt

      - name: Check import vÃ  syntax
        run: |
          python -c "import verimodel; print('âœ… Import successful')"
          python -c "from verimodel.api_server import app; print('âœ… API server import successful')"
          python -c "from verimodel.static_scanner import StaticScanner; print('âœ… Static scanner import successful')"
          python -c "from verimodel.cli import app as cli_app; print('âœ… CLI import successful')"

      - name: Test API server startup (dry run)
        run: |
          python -c "
          from verimodel.api_server import app
          print('âœ… API server cÃ³ thá»ƒ khá»Ÿi táº¡o')
          print(f'Title: {app.title}')
          print(f'Version: {app.version}')
          "

  # Deployment files validation
  validate_deployment:
    name: Validate Deployment Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Check vercel.json exists and valid
        run: |
          if [ ! -f vercel.json ]; then
            echo "âŒ vercel.json khÃ´ng tá»“n táº¡i"
            exit 1
          fi
          echo "âœ… vercel.json tá»“n táº¡i"
          # Validate JSON syntax
          python -c "import json; json.load(open('vercel.json')); print('âœ… vercel.json há»£p lá»‡')"

      - name: Check api/index.py exists
        run: |
          if [ ! -f api/index.py ]; then
            echo "âŒ api/index.py khÃ´ng tá»“n táº¡i"
            exit 1
          fi
          echo "âœ… api/index.py tá»“n táº¡i"

      - name: Check runtime.txt
        run: |
          if [ ! -f runtime.txt ]; then
            echo "âš ï¸ runtime.txt khÃ´ng tá»“n táº¡i (tÃ¹y chá»n)"
          else
            echo "âœ… runtime.txt tá»“n táº¡i"
            cat runtime.txt
          fi

      - name: Validate Python syntax in api/index.py
        run: |
          python -m py_compile api/index.py
          echo "âœ… api/index.py cÃ³ syntax há»£p lá»‡"

  # Summary job - cháº¡y cuá»‘i cÃ¹ng Ä‘á»ƒ tá»•ng há»£p káº¿t quáº£
  ci_summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, test, security_scan, build_check, validate_deployment]
    if: always()
    steps:
      - name: CI Status
        run: |
          echo "## ðŸŽ¯ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security_scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Check | ${{ needs.build_check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment Validation | ${{ needs.validate_deployment.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.lint.result }}" = "success" ] && \
             [ "${{ needs.test.result }}" = "success" ] && \
             [ "${{ needs.build_check.result }}" = "success" ] && \
             [ "${{ needs.validate_deployment.result }}" = "success" ]; then
            echo "âœ… **All checks passed!**" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "âŒ **Some checks failed. Please review the logs above.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi